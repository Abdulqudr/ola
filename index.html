<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Four in a Row</title>
  <link rel="stylesheet" href="style.css">

  <!-- Mini App Discovery -->
  <meta property="fc:miniapp" content="https://ola-azure.vercel.app/.well-known/farcaster.json">

  <!-- PERFECT EMBED CARD (exact format from docs/friend example) -->
  <meta name="fc:miniapp" content='{
    "version": "next",
    "imageUrl": "https://ola-azure.vercel.app/hero.png",
    "button": {
      "title": "Play Connect Four",
      "action": {
        "type": "launch_miniapp",
        "name": "Four in a Row",
        "url": "https://ola-azure.vercel.app"
      }
    }
  }' />

  <!-- Fallback Open Graph (for Twitter/Discord) -->
  <meta property="og:title" content="Four in a Row">
  <meta property="og:description" content="Beat the AI ¬∑ streaks ¬∑ achievements ¬∑ multiplayer">
  <meta property="og:image" content="https://ola-azure.vercel.app/hero.png">
</head>
<body>
  <!-- Dashboard Screen -->
  <div id="dashboardScreen" class="screen active">
    <div class="dashboard">
      <div class="dashboard-header">
        <h1 class="dashboard-title">CONNECT 4</h1>
        <p class="dashboard-subtitle">Think. Block. Connect. Win.</p>
      </div>
      
      <div class="dashboard-menu">
        <button id="newGameBtn" class="dashboard-btn primary">
          <span class="btn-icon">üéÆ</span>
          New Game
        </button>
        <button id="multiplayerBtn" class="dashboard-btn">
          <span class="btn-icon">üë•</span>
          Multiplayer
        </button>
        <button id="authBtn" class="dashboard-btn">
          <span class="btn-icon">üîê</span>
          Sign In
        </button>
        <button id="leaderboardBtn" class="dashboard-btn">
          <span class="btn-icon">üèÜ</span>
          Leaderboard
        </button>
        <button id="dashboardSettingsBtn" class="dashboard-btn">
          <span class="btn-icon">‚öôÔ∏è</span>
          Settings
        </button>
      </div>
      
      <div class="dashboard-footer">
        <div class="current-streak" id="dashboardStreak">
          Current Streak: <span id="streakCount">0</span> üî•
        </div>
      </div>
    </div>
  </div>

  <!-- Game Screen -->
  <div id="gameScreen" class="screen hidden">
    <div class="app">
      <header class="topbar">
        <div class="player-info">
          <div class="player-avatar">
            <img src="assets/avatars/male-avatar.png" alt="You" class="avatar-image">
            <div class="avatar-fallback">‚ôÇ</div>
          </div>
          <div class="player-name">You</div>
          <div class="win-counter">Wins: <span id="playerWins" class="win-count">0</span></div>
          <div class="player-disk-indicator player-color"></div>
        </div>
        
        <div class="game-status">
          <div class="status-text" id="statusText">YOUR TURN</div>
          <div class="game-mode-indicator" id="gameModeIndicator">vs AI</div>
        </div>
        
        <div class="player-info opponent">
          <div class="player-avatar">
            <img src="assets/avatars/ai-avatar.png" alt="Computer" class="avatar-image">
            <div class="avatar-fallback">AI</div>
          </div>
          <div class="player-name" id="opponentName">Computer</div>
          <div class="win-counter">Wins: <span id="aiWins" class="win-count">0</span></div>
          <div class="player-disk-indicator ai-color"></div>
        </div>
      </header>

      <main class="game-area">
        <div class="board-wrap">
          <div id="aiPulse" class="ai-pulse hidden" aria-hidden="true"></div>
          <div id="board" class="board" aria-label="Connect Four board"></div>
        </div>
      </main>

      <div class="bottom-controls">
        <button id="helpBtn" class="icon-btn help-icon" aria-label="How to Play">
          <span>?</span>
        </button>
        
        <button id="backToDashboardBtn" class="back-btn">BACK</button>
        
        <button id="statsBtn" class="icon-btn" aria-label="Statistics">
          üìä
        </button>
      </div>

      <div id="overlay" class="overlay hidden" aria-hidden="true">
        <div class="overlay-card">
          <div id="overlayMessage" class="overlay-message"></div>
          <div class="overlay-actions">
            <button id="overlayNew" class="btn primary">Play Again</button>
            <button id="overlayDashboard" class="btn">Dashboard</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Auth Modal -->
  <div id="authModal" class="modal hidden" aria-hidden="true">
    <div class="modal-content">
      <h2>Sign In</h2>
      <div id="authContent">
        <div class="modal-section">
          <p>Connect your Farcaster account to track your progress and compete on leaderboards!</p>
        </div>
        <div class="modal-actions">
          <button id="signInBtn" class="btn primary">Sign In with Farcaster</button>
          <button id="closeAuthBtn" class="btn">Maybe Later</button>
        </div>
      </div>
      <div id="authSuccess" class="hidden">
        <div class="modal-section">
          <p>‚úÖ Successfully signed in as FID: <span id="userFid"></span></p>
        </div>
        <div class="modal-actions">
          <button id="signOutBtn" class="btn">Sign Out</button>
          <button id="closeAuthSuccessBtn" class="btn primary">Continue Playing</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal hidden" aria-hidden="true">
    <div class="modal-content">
      <h2>Settings</h2>
      
      <div class="modal-section">
        <label>Difficulty:
          <select id="difficulty">
            <option value="easy" selected>Easy</option>
            <option value="medium">Medium</option>
            <option value="hard">Hard</option>
          </select>
        </label>
      </div>

      <div class="modal-section">
        <label>Your Avatar:
          <select id="avatarSelect">
            <option value="male">Male</option>
            <option value="female">Female</option>
          </select>
        </label>
      </div>
      
      <div class="modal-section">
        <label>Theme:
          <select id="themeSelect">
            <option value="neon">Neon</option>
            <option value="white">White</option>
          </select>
        </label>
      </div>
      
      <div class="modal-section">
        <label class="toggle-label">
          <span>Sound</span>
          <div class="toggle-container">
            <input type="checkbox" id="soundToggle" checked />
            <span class="toggle-slider">
              <span class="toggle-text-on">ON</span>
              <span class="toggle-text-off">OFF</span>
            </span>
          </div>
        </label>
      </div>
      
      <div class="modal-actions">
        <button id="closeSettingsBtn" class="btn primary">Close</button>
      </div>
    </div>
  </div>

  <!-- Help Modal -->
  <div id="helpModal" class="modal hidden" aria-hidden="true">
    <div class="modal-content">
      <h2>How to Play</h2>
      <div class="help-content">
        <p><strong>Objective:</strong> Be the first to connect four of your discs in a row horizontally, vertically, or diagonally.</p>
        
        <p><strong>Game Modes:</strong></p>
        <ul>
          <li>üéÆ <strong>Single Player:</strong> Play against AI with 3 difficulty levels</li>
          <li>üë• <strong>Multiplayer:</strong> Play against a friend on the same device</li>
        </ul>
        
        <p><strong>Gameplay:</strong></p>
        <ul>
          <li>Tap on any column to drop your disc</li>
          <li>Discs fall to the lowest available space in the column</li>
          <li>Take turns with your opponent</li>
          <li>First to get four in a row wins!</li>
        </ul>
        
        <p><strong>Features:</strong></p>
        <ul>
          <li>üî• Win streaks for consecutive wins</li>
          <li>üèÜ 22+ achievements across 4 difficulty tiers</li>
          <li>üìä Track your statistics and progress</li>
          <li>üé® Multiple themes and avatars</li>
          <li>üë• Single Player & Multiplayer modes</li>
        </ul>
      </div>
      <div class="modal-actions">
        <button id="closeHelpBtn" class="btn primary">Got It</button>
      </div>
    </div>
  </div>

  <!-- Stats Modal -->
  <div id="statsModal" class="modal hidden" aria-hidden="true">
    <div class="modal-content">
      <h2>Game Statistics</h2>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="statTotalGames">0</div>
          <div class="stat-label">Total Games</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statWinRate">0%</div>
          <div class="stat-label">Win Rate</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statCurrentStreak">0</div>
          <div class="stat-label">Current Streak</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statBestStreak">0</div>
          <div class="stat-label">Best Streak</div>
        </div>
      </div>
      
      <h3 style="margin-top: 24px;">Achievements</h3>
      <div class="achievement-list" id="achievementList">
        <!-- Achievements will be populated by JavaScript -->
      </div>
      
      <div class="modal-actions">
        <button id="closeStatsBtn" class="btn primary">Close</button>
      </div>
    </div>
  </div>

  <!-- Leaderboard Modal -->
  <div id="leaderboardModal" class="modal hidden" aria-hidden="true">
    <div class="modal-content">
      <h2>Leaderboard</h2>
      <div class="leaderboard-content">
        <div class="leaderboard-tabs">
          <button class="leaderboard-tab active" data-tab="single">Single Player</button>
          <button class="leaderboard-tab" data-tab="multiplayer">Multiplayer</button>
        </div>
        
        <div id="singleLeaderboard" class="leaderboard-list active">
          <!-- Single player leaderboard will be populated by JavaScript -->
        </div>
        
        <div id="multiplayerLeaderboard" class="leaderboard-list">
          <!-- Multiplayer leaderboard will be populated by JavaScript -->
        </div>
      </div>
      <div class="modal-actions">
        <button id="closeLeaderboardBtn" class="btn primary">Close</button>
      </div>
    </div>
  </div>

  <!-- Audio -->
  <audio id="sfxPlace" src="sounds/drop.mp3" preload="auto"></audio>
  <audio id="sfxWin" src="sounds/win.mp3" preload="auto"></audio>

  <!-- Your game logic -->
  <script src="app.js"></script>

  <!-- Auth System -->
  <script>
    class FarcasterAuth {
      constructor() {
        this.token = null;
        this.userData = null;
        this.isInitialized = false;
      }

      async init() {
        if (this.isInitialized) return;

        try {
          // Load saved auth state
          const savedAuth = localStorage.getItem('connect4_auth');
          if (savedAuth) {
            const authData = JSON.parse(savedAuth);
            this.token = authData.token;
            this.userData = authData.userData;
            this.updateAuthUI();
          }

          this.setupEventListeners();
          this.isInitialized = true;
        } catch (error) {
          console.error('Auth initialization error:', error);
        }
      }

      setupEventListeners() {
        // Auth modal triggers
        const authBtn = document.getElementById('authBtn');
        const signInBtn = document.getElementById('signInBtn');
        const signOutBtn = document.getElementById('signOutBtn');
        const closeAuthBtn = document.getElementById('closeAuthBtn');
        const closeAuthSuccessBtn = document.getElementById('closeAuthSuccessBtn');

        if (authBtn) authBtn.addEventListener('click', () => this.showAuthModal());
        if (signInBtn) signInBtn.addEventListener('click', () => this.signIn());
        if (signOutBtn) signOutBtn.addEventListener('click', () => this.signOut());
        if (closeAuthBtn) closeAuthBtn.addEventListener('click', () => this.hideAuthModal());
        if (closeAuthSuccessBtn) closeAuthSuccessBtn.addEventListener('click', () => this.hideAuthModal());
      }

      async signIn() {
        try {
          // Use Farcaster Mini App SDK for authentication
          if (typeof sdk !== 'undefined') {
            const { token } = await sdk.quickAuth.getToken();
            this.token = token;
            
            // Verify token with backend
            const response = await fetch('/api/auth', {
              headers: { 
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json"
              }
            });
            
            if (response.ok) {
              const userData = await response.json();
              this.userData = userData;
              
              // Save auth state
              localStorage.setItem('connect4_auth', JSON.stringify({
                token: this.token,
                userData: this.userData
              }));
              
              this.updateAuthUI();
              this.showAuthSuccess();
              this.onAuthSuccess(userData);
            } else {
              throw new Error('Authentication failed');
            }
          } else {
            // Fallback for non-miniapp environment
            this.showDesktopAuthMessage();
          }
        } catch (error) {
          console.error('Sign in error:', error);
          alert('Sign in failed. Please try again.');
        }
      }

      signOut() {
        this.token = null;
        this.userData = null;
        localStorage.removeItem('connect4_auth');
        this.updateAuthUI();
        this.hideAuthModal();
        this.onSignOut();
      }

      updateAuthUI() {
        const authBtn = document.getElementById('authBtn');
        const userFidEl = document.getElementById('userFid');
        
        if (this.userData) {
          if (authBtn) authBtn.innerHTML = '<span class="btn-icon">üë§</span> Signed In';
          if (userFidEl) userFidEl.textContent = this.userData.fid;
        } else {
          if (authBtn) authBtn.innerHTML = '<span class="btn-icon">üîê</span> Sign In';
        }
      }

      showAuthModal() {
        const authModal = document.getElementById('authModal');
        const authContent = document.getElementById('authContent');
        const authSuccess = document.getElementById('authSuccess');
        
        if (authModal) {
          authModal.classList.remove('hidden');
          if (this.userData) {
            authContent.classList.add('hidden');
            authSuccess.classList.remove('hidden');
          } else {
            authContent.classList.remove('hidden');
            authSuccess.classList.add('hidden');
          }
        }
      }

      hideAuthModal() {
        const authModal = document.getElementById('authModal');
        if (authModal) authModal.classList.add('hidden');
      }

      showAuthSuccess() {
        const authContent = document.getElementById('authContent');
        const authSuccess = document.getElementById('authSuccess');
        
        if (authContent) authContent.classList.add('hidden');
        if (authSuccess) authSuccess.classList.remove('hidden');
      }

      showDesktopAuthMessage() {
        alert('üîê Authentication is available in the Farcaster mobile app. Open this mini app in Warpcast to sign in and track your progress!');
        this.hideAuthModal();
      }

      onAuthSuccess(userData) {
        console.log('User authenticated:', userData);
        // You can add leaderboard integration, cloud save, etc. here
        this.syncGameStats(userData.fid);
      }

      onSignOut() {
        console.log('User signed out');
        // Handle sign out cleanup
      }

      async syncGameStats(fid) {
        // Sync local game stats with authenticated user
        const gameStats = localStorage.getItem('four_gameStats');
        if (gameStats) {
          // Here you would typically send to your backend
          console.log('Syncing stats for FID:', fid, gameStats);
        }
      }

      isAuthenticated() {
        return !!this.userData;
      }

      getUserData() {
        return this.userData;
      }
    }

    // Initialize auth when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      window.farcasterAuth = new FarcasterAuth();
      window.farcasterAuth.init();
    });
  </script>

  <!-- OFFICIAL ESM SDK + READY CALL (fixes splash) -->
  <script type="module">
    import { sdk } from 'https://esm.sh/@farcaster/miniapp-sdk';

    // Fresh start for new players
    if (!localStorage.getItem('connect4_visited')) {
      localStorage.clear();
      localStorage.setItem('connect4_visited', 'true');
    }

    // Dismiss splash screen after app loads
    window.addEventListener('load', async () => {
      try {
        await sdk.actions.ready();
        console.log('Mini App ready ‚Äî splash dismissed!');
      } catch (e) {
        console.log('Not in Mini App (desktop mode)');
      }
    });
  </script>
</body>
</html>
