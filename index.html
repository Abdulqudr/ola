<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Four in a Row</title>
  <link rel="stylesheet" href="style.css" />

  <!-- REQUIRED FOR BASE MINI APP -->
  <meta property="fc:miniapp" content="https://ola-azure.vercel.app/.well-known/farcaster.json">
  <meta property="og:title" content="Four in a Row">
  <meta property="og:description" content="Classic Connect Four vs AI or friend — achievements, streaks, multiplayer!">
  <meta property="og:image" content="https://ola-azure.vercel.app/hero.png">

  <!-- Favicon -->
  <link rel="icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='12' fill='%23031226'/><circle cx='40' cy='50' r='18' fill='%23FF6B35'/><circle cx='60' cy='50' r='18' fill='%23FFD23F'/></svg>">
</head>
<body>
  <div class="app">
    <!-- YOUR ENTIRE ORIGINAL HTML (header, board, modals, etc.) — unchanged -->
    <header class="topbar">
      <div class="player-info">
        <div class="player-avatar">
          <img src="assets/avatars/male-avatar.png" alt="You" class="avatar-image">
          <div class="avatar-fallback">Male</div>
        </div>
        <div class="player-name">You</div>
        <div class="win-counter">Wins: <span id="playerWins" class="win-count">0</span></div>
        <div class="player-disk-indicator player-color"></div>
      </div>
      <div class="game-status">
        <div class="status-text" id="statusText">YOUR TURN</div>
        <div class="game-mode-indicator" id="gameModeIndicator">vs AI</div>
      </div>
      <div class="player-info opponent">
        <div class="player-avatar">
          <img src="assets/avatars/ai-avatar.png" alt="Computer" class="avatar-image">
          <div class="avatar-fallback">AI</div>
        </div>
        <div class="player-name" id="opponentName">Computer</div>
        <div class="win-counter">Wins: <span id="aiWins" class="win-count">0</span></div>
        <div class="player-disk-indicator ai-color"></div>
      </div>
    </header>

    <main class="game-area">
      <div class="board-wrap">
        <div id="aiPulse" class="ai-pulse hidden" aria-hidden="true"></div>
        <div id="board" class="board" aria-label="Connect Four board"></div>
      </div>
    </main>

    <div class="bottom-controls">
      <button id="helpBtn" class="icon-btn help-icon" aria-label="How to Play"><span>?</span></button>
      <button id="newGameBtn" class="new-game-btn">NEW GAME</button>
      <button id="statsBtn" class="icon-btn" aria-label="Statistics">Stats</button>
      <button id="settingsBtn" class="icon-btn settings-icon" aria-label="Settings">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">...</svg>
      </button>
    </div>

    <!-- ALL YOUR MODALS (overlay, settings, help, stats, multiplayer) — keep exactly as you have them -->
    <!-- (They are perfect — no changes needed) -->

    <!-- Audio -->
    <audio id="sfxPlace" src="sounds/drop.mp3" preload="auto"></audio>
    <audio id="sfxWin" src="sounds/win.mp3" preload="auto"></audio>
  </div>

  <!-- 1. Load Base Mini App SDK FIRST -->
  <script async src="https://cdn.jsdelivr.net/npm/@farcaster/miniapp-sdk@0.2.3/dist/sdk.js"></script>

  <!-- 2. Your original game logic (unchanged) -->
  <script src="app.js"></script>

  <!-- 3. BULLETPROOF READY SIGNAL — this is what stops the browser redirect -->
  <script>
    // Ultra-reliable ready signal with 10 fast retries
    let attempts = 0;
    function sendReady() {
      if (window.MiniAppSdk?.actions?.ready) {
        window.MiniAppSdk.actions.ready()
          .then(() => console.log('READY signal sent — game will stay embedded!'))
          .catch(e => console.log('Ready failed:', e));
        return;
      }
      if (attempts < 10) {
        attempts++;
        console.log(`Attempt ${attempts}/10 to send ready...`);
        setTimeout(sendReady, 200);
      }
    }

    // Fire as early as possible
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => setTimeout(sendReady, 100));
    } else {
      setTimeout(sendReady, 100);
    }
    window.addEventListener('load', sendReady);
  </script>
</body>
</html>
